---
title: "Assignment"
description: |
  This assignment is aim to solve the problems of for Mini Challenge 2
author:
  - name: LI NAN
    url: https://www.linkedin.com/in/li-nan-63b9251a6/
date: 07-12-2021
output:
  distill::distill_article:
    toc: true
    toc_depth: 3



---

## 1.Data Preparation

### 1.1 Global Settings

The global settings of R code chunks in this post is set as follows. 

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(fig.retina = 3,
                      echo = TRUE,
                      eval = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

### 1.2 R Packages Installation

The following code input is to prepare for R Packages Installation.

```{r}
packages = c('raster','sf','tmap', 'clock','DT', 'ggiraph', 'plotly', 'tidyverse','dplyr','readr','hrbrthemes','tmap')
for(p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}

```

### 1.3 Data Import
The following code is to import raw data sets from [<font size="3"  color="blue">*Mini Challenge2*</font>](https://vast-challenge.github.io/2021/MC2.html)("*car-assignment.csv*","*cc_data.csv*","*gps.csv*","*loyalty_data.csv*").

```{r}
credit_debit <- read_csv("data/cc_data.csv")
loyalty_data <- read_csv("data/loyalty_data.csv")
car_assignment <- read_csv("data/car_assignments.csv")
GPS <- read_csv("data/gps.csv")
glimpse(credit_debit)
glimpse(loyalty_data)
glimpse(GPS)
head(loyalty_data)
head(credit_debit)
```
## 2.Tasks and Questions for Mini-Challenge2

### 2.1 Q1 Intruoduction

Using just the credit and loyalty card data, identify the most popular locations, and when they are popular. What anomalies do you see? What corrections would you recommend to correct these anomalies?


#### 2.1.1 Data Preparation for Q1


**Comparison of total amount between credit/debit card and loyalty card**



After glimpsing data structure of credit and loyalty card data, the heat map is a good way to visualize the most population locations and its population time.To create this graph,the data aggregation of loyalty card is needed.

```{r}
loyalty_data$count_event=1
credit_debit$count_event=1
head(loyalty_data)
aggregate_dataset <- loyalty_data %>% 
    group_by(timestamp,location) %>% 
    dplyr::summarize(Frequency = sum(count_event),Money_loyalty=sum(price))
head(aggregate_dataset)

credit_debit$timestamp <- as.Date(credit_debit$timestamp, "%m/%d/%Y")
aggregate_cc <- credit_debit %>% 
    group_by(timestamp,location) %>% 
    dplyr::summarize(Frequency = sum(count_event),Money_cd=sum(price))
head(aggregate_cc)


```
**Adjustment of Date Type and create a new column named"Day"**
```{r}
aggregate_dataset$timestamp <- as.Date(aggregate_dataset$timestamp, "%m/%d/%Y")

aggregate_dataset$Day <- format(aggregate_dataset$timestamp, format="%d")
aggregate_cc$Day <- format(aggregate_cc$timestamp, format="%d")
```


```{r}
head(aggregate_dataset)
head(aggregate_cc)
```

**new column: text for tooltip**
```{r}
aggregate_dataset <- aggregate_dataset %>%
  mutate(text = paste0("Location: ", location, "\n", "Day of January: ", Day, "\n", "Frequency: ",Frequency))

aggregate_cc <- aggregate_cc %>%
  mutate(text2 = paste0("Location: ", location, "\n", "Day of January: ", Day, "\n", "Frequency: ",Frequency))
```

#### 2.1.2 Data Visualization

**Heat map for loyalty card usage frequency per day**
```{r,fig.height=6,fig.width=10}
p <- ggplot(data = aggregate_dataset, aes(x=Day, y=location,fill=Frequency,text=text)) + 
  geom_tile() +
  scale_fill_gradient(low="light yellow", high="dark blue") +
  theme_ipsum()

p <- p + theme(axis.text.y = element_text(size = 8))

ggplotly(p, tooltip="text")
```

**Heat map for credit_debit card usage frequency per day**
```{r,fig.height=6,fig.width=10}
z <- ggplot(data = aggregate_cc, aes(x=Day, y=location,fill=Frequency,text=text2)) + 
  geom_tile() +
  scale_fill_gradient(low="light yellow", high="red") +
  theme_ipsum()

z <- z + theme(axis.text.y = element_text(size = 8))

ggplotly(z, tooltip="text2")
```

#### 2.1.3 Infer and Analysis

Based on heat maps which show the phenomena of loyalty card and credit_debit card usage, we can infer that the most popular places from Ja.06 to Jan.19 are Brew've Been Served and Katerina's Cafe,since the color of heatmap are the most dark in these two places.
However,from the tooltips, we can also see some difference between the frequencies of these two types of card usage, which are abnormal. So the next step is to build up new data frame to see the difference of cost record and frequency difference between these two types of cards more obviously.


```{r}
loyalty_money <- aggregate_dataset %>% group_by(Day,location) %>% dplyr::summarise(max_loyal=max(Money_loyalty),freq_loyal=sum(Frequency))
head(aggregate_dataset)
head(loyalty_money)
dplyr::count(loyalty_money)
```

```{r}
cc_money <- aggregate_cc %>% group_by(Day,location) %>% dplyr::summarise(max_cc = max(Money_cd),freq_cc=sum(Frequency))
head(cc_money)
dplyr::count(cc_money)

```
From the new data frame shown, we can see that some records that can be matched,whose frequencies are equal and money can be matched, but some are not.
And most abnormal situation is that,in one day,the money cost shown in loyalty card is lower than money cost in credit/debit card,but the frequencies of loyalty card in that day is higher than that of credit card in same place,which needs to be noticed.


**Another thoughts for Q1 Visualization**
Compared with Heat map, do we have better ways to visual, how about design line chart based on time period for the differences of money....



### 2.2 Q2 Intruoduction
Add the vehicle data to your analysis of the credit and loyalty card data. How does your assessment of the anomalies in question 1 change based on this new data? What discrepancies between vehicle, credit, and loyalty card data do you find? Please limit your answer to 8 images and 500 words.

#### 2.2.1 Data Preparation for Q2

First,"MC2-tourist.jpg" is imported for data preparation.

```{r}
bgmap <- raster("Data/MC2-tourist.tif")
bgmap
```



```{r}
tm_shape(bgmap) +
tm_rgb(bgmap, r = 1,g = 2,b = 3,
       alpha = NA,
       saturation = 1,
       interpolate = TRUE,
       max.value = 255)
```

```{r}
Abila_st <- st_read(dsn = "Data/Geospatial",
                    layer = "Abila")

```

```{r}
glimpse(GPS)
```


```{r}
GPS$Timestamp <- strptime(GPS$Timestamp, "%m/%d/%Y %H:%M:%S")
GPS$day <- as.factor(get_day(GPS$Timestamp))

```

```{r}
GPS$id <- as_factor(GPS$id)
```

```{r}
glimpse(GPS)

```

### 这一步起应该与老师有所不同 ###



```{r}
GPS_sf <- st_as_sf(GPS, 
                   coords = c("long", "lat"),
                       crs= 4326)
GPS_sf
```

```{r}
gps_path <- GPS_sf %>%
  group_by(id, day) %>%
  summarize(m = mean(Timestamp), 
            do_union=FALSE) %>%
  st_cast("LINESTRING")
gps_path
```


```{r}
gps_path_selected <- gps_path %>%
  filter(id==1)
tmap_mode("view")
tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1,g = 2,b = 3,
       alpha = NA,
       saturation = 1,
       interpolate = TRUE,
       max.value = 255) +
  tm_shape(gps_path_selected) +
  tm_lines()
```


```{r}
m <- tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1,g = 2,b = 3,
       alpha = NA,
       saturation = 1,
       interpolate = TRUE,
       max.value = 255) +
  tm_shape(gps_path) +
  tm_lines() +
  tm_facets(along = "id")
tmap_animation(m, 
               filename = "gif/drivers.gif",
               delay=40)
```





